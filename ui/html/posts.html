<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Posts - Home</title>
    <style>
        body {
            font-family: Arial, sans-serif;
    margin: 0;
    padding: 0;
    background-color: #f5f5f5;
    overflow-x: hidden; /* Only prevent horizontal overflow */
    overflow-y: auto; /* Allow vertical scrolling */
}

body:not(.page-loaded) .container {
    opacity: 0.8;
    transition: opacity 0.2s ease;
}

body.page-loaded .container {
    opacity: 1;
}


        .container {
            max-width: 1200px;
    margin: 20px auto;
    padding: 0 20px;
    min-height: 80vh; /* Use viewport height instead of fixed pixel value */
}

        .navbar {
            background-color: #2c3e50;
            color: white;
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .navbar-brand {
            font-size: 1.5rem;
            font-weight: bold;
            text-decoration: none;
            color: white;
        }

        .navbar-nav {
            display: flex;
            gap: 1rem;
        }

        .nav-btn {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            text-decoration: none;
            font-size: 0.9rem;
        }

        .nav-btn:hover {
            background-color: #2980b9;
        }

        .logout-btn {
            background-color: #e74c3c;
        }

        .logout-btn:hover {
            background-color: #c0392b;
        }

        .container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 0 20px;
        }

        .post {
            border: 1px solid #ccc;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
            background-color: white;
        }

        .post h2 {
            margin-top: 0;
            color: #2c3e50;
        }

        .post img {
            max-width: 100%;
            height: auto;
            margin-top: 10px;
        }

        .actions {
            margin-top: 10px;
        }

        .actions button {
            margin-right: 10px;
        }

        .media-container {
            position: relative;
            margin: 1rem 0;
            max-width: 100%;
            overflow: hidden;
            min-height: 50px;
            width: 100%;
        }

        .post-media {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
        }

        .category-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 10px 0;
        }

        .category-option {
            display: flex;
            align-items: center;
        }

        .category-tag {
            background-color: #eaeaea;
            padding: 3px 8px;
            border-radius: 3px;
            margin-right: 5px;
            font-size: 0.8rem;
        }

        .forms-section {
            margin: 20px 0;
            padding: 20px;
            background-color: white;
            border-radius: 5px;
            border: 1px solid #ddd;
        }

        form {
            margin-bottom: 20px;
        }

        input[type="text"], input[type="file"] {
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 100%;
            max-width: 400px;
        }

        button[type="submit"] {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
        }

        button[type="submit"]:hover {
            background-color: #2980b9;
        }

        hr {
            border: 0;
            height: 1px;
            background-color: #eaeaea;
            margin: 20px 0;
        }

        .comment {
            background-color: #f9f9f9;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
    </style>
</head>

<body>
    <!-- Navigation Bar -->
    <nav class="navbar">
        <a href="/" class="navbar-brand">Social Posts</a>
        <div class="navbar-nav" id="nav-container">
            <!-- Navbar will be populated by JavaScript based on login status -->
        </div>
    </nav>

    <div class="container">
        <!-- Create Post Form (visible only to logged-in users) -->
        <div id="create-post-section" class="forms-section" style="display: none;">
            <h2>Create New Post</h2>
            <form action="/post" method="POST" id="createPostForm" enctype="multipart/form-data">
                <div>
                    <label>Title </label>
                    <input type="text" name="post_title" placeholder="title" required>
                </div>
                <div>
                    <label>Content </label>
                    <input type="text" name="post_content" placeholder="What's up" required>
                </div>
                <div>
                    <label for="media">Upload Media (Image, Video, or GIF):</label>
                    <input type="file" id="media" name="media" accept=".jpg,.jpeg,.png,.gif,.mp4,.mov,.webm">
                </div>
                <div>
                    <label for="categories">Categories:</label>
                    <div class="category-group">
                        {{range .Categories}}
                        <div class="category-option">
                            <input type="checkbox" id="cat-{{.ID}}" name="categories" value="{{.Name}}">
                            <label for="cat-{{.ID}}">{{.Name}}</label>
                        </div>
                        {{end}}
                    </div>
                </div>
                <button type="submit">Create Post</button>
            </form>
        </div>

        <!-- Filter Posts Form (visible to all users) -->
        <div class="forms-section">
            <h2>Filter Posts</h2>
            <form action="/filtered_posts" method="POST" id="filterposts">
                <label for="categories">Filter by Categories:</label>
                <div class="category-group">
                    {{range .Categories}}
                    <div class="category-option">
                        <input type="checkbox" id="filter-cat-{{.ID}}" name="categories" value="{{.Name}}">
                        <label for="filter-cat-{{.ID}}">{{.Name}}</label>
                    </div>
                    {{end}}
                </div>
                <button type="submit">Apply Filter</button>
            </form>
        </div>

        <!-- Posts Display Section -->
        <h1>Posts</h1>
        {{range .Posts}}
        <div class="post">
            <h2>{{.Title}}</h2>
            <p>{{.Content}}</p>
            <p><small>by {{.Username}}</small></p>
            <!-- Display categories -->
            <div class="categories">
                Categories:
                {{range .Categories}}
                <span class="category-tag">{{.Name}}</span>
                {{end}}
            </div>
            
            {{if .Media}}
            <div class="media-container">
                {{if or (eq .ContentType "image/jpeg") (eq .ContentType "image/png") (eq .ContentType "image/gif")}}
                <img src="data:{{.ContentType}};base64,{{.Media}}" alt="Post image" class="post-media">
                {{else if or (eq .ContentType "video/mp4") (eq .ContentType "video/quicktime") (eq .ContentType
                "video/webm")}}
                <video controls class="post-media">
                    <source src="data:{{.ContentType}};base64,{{.Media}}" type="{{.ContentType}}">
                    Your browser does not support the video tag.
                </video>
                {{end}}
            </div>
            {{end}}

            <!-- Like & Dislike Form -->
            <form class="like-form" action="/likes" method="POST">
                <input type="hidden" name="id" value="{{.ID}}">
                <input type="hidden" name="item_type" value="post">
                <button type="submit" name="type" value="like">
                    üëç Like (<span id="like-count-post-{{.ID}}">{{.Likes}}</span>)
                </button>
                <button type="submit" name="type" value="dislike">
                    üëé Dislike (<span id="dislike-count-post-{{.ID}}">{{.Dislikes}}</span>)
                </button>
            </form>

            <!-- Comment Form (visible only to logged-in users) -->
            <form action="/add_comment" method="POST" class="comment-form" id="comments-{{.ID}}">
                <input type="hidden" name="post_id" value="{{.ID}}">
                <input type="text" name="content" placeholder="Add a comment...">
                <button type="submit">üí¨ Comment</button>
            </form>

            <!-- Comments Section -->
            <h4>Comments</h4>
            {{range .Comments}}
            <div class="comment">
                <p>{{.Content}}</p>
                <p><small>Posted on {{.CreatedAt}}</small></p>

                <!-- Comment Like & Dislike Form -->
                <form class="like-form" action="/likes" method="POST">
                    <input type="hidden" name="id" value="{{.ID}}">
                    <input type="hidden" name="item_type" value="comment">
                    <button type="submit" name="type" value="like">
                        üëç Like (<span id="like-count-comment-{{.ID}}">{{.Likes}}</span>)
                    </button>
                    <button type="submit" name="type" value="dislike">
                        üëé Dislike (<span id="dislike-count-comment-{{.ID}}">{{.Dislikes}}</span>)
                    </button>
                </form>
                
                <!-- Reply Form (visible only to logged-in users) -->
                <form action="/add_reply" method="POST" class="reply-form" id="reply-{{.ID}}">
                    <input type="hidden" name="parent_comment_id" value="{{.ID}}">
                    <input type="text" name="content" placeholder="Reply to this comment...">
                    <button type="submit">‚Ü©Ô∏è Reply</button>
                </form>
            </div>
            {{end}}
        </div>
        {{end}}
    </div>

    <script>
        // Check if user is logged in
        async function checkLoginStatus() {
            try {
                const response = await fetch('/api/check-auth', {
                    method: 'GET',
                    credentials: 'include'
                });
                
                if(response.ok) {
                    const data = await response.json();
                    return data.isLoggedIn;
                }
                return false;
            } catch (error) {
                console.error('Error checking login status:', error);
                return false;
            }
        }

        // Update UI based on login status
        async function updateUI() {
            const isLoggedIn = await checkLoginStatus();
            const navContainer = document.getElementById('nav-container');
            const createPostSection = document.getElementById('create-post-section');
            
            // Clear existing nav buttons
            navContainer.innerHTML = '';
            
            if (isLoggedIn) {
                // Show logout button
                navContainer.innerHTML = `
                    <a href="/profile" class="nav-btn">Profile</a>
                    <button class="nav-btn logout-btn" id="logoutBtn">Logout</button>
                `;
                // Show create post form
                if(createPostSection) {
                    createPostSection.style.display = 'block';
                }
                
                   // Show all forms that need authentication
        document.querySelectorAll('.comment-form, .reply-form').forEach(form => {
            form.style.display = 'block';
        });

                // Hide all forms that need authentication from non-logged-in users
                document.querySelectorAll('.comment-form, .reply-form').forEach(form => {
                    form.style.display = 'block';
                });
                
                // Add logout functionality
                document.getElementById('logoutBtn').addEventListener('click', async () => {
                    const response = await fetch('/logout', {
                        method: 'POST',
                        credentials: 'include'
                    });
                    
                    if (response.ok) {
                        window.location.href = '/';
                    }
                });
            } else {
                // Show login and register buttons
                navContainer.innerHTML = `
                    <a href="/login" class="nav-btn">Login</a>
                    <a href="/register" class="nav-btn">Register</a>
                `;
                // Hide create post form
                 if (createPostSection) {
            createPostSection.style.display = 'none';
            
            // Check if there's already a prompt to avoid duplicates
            const existingPrompt = document.getElementById('create-post-prompt');
            if (!existingPrompt) {
                // Add a "Create Post" button that redirects to login
                const createPostPrompt = document.createElement('div');
                createPostPrompt.id = 'create-post-prompt';
                createPostPrompt.className = 'forms-section';
                createPostPrompt.innerHTML = `
                    <h2>Create New Post</h2>
                    <p>Please <a href="/login">log in</a> to create a post</p>
                    <button id="login-to-post" class="nav-btn">Login to Post</button>
                `;
                createPostSection.parentNode.insertBefore(createPostPrompt, createPostSection);
                // Add event listener to the login button
                document.getElementById('login-to-post').addEventListener('click', () => {
                    window.location.href = '/login';
                });
            }
        }
                
                // Hide all forms that need authentication from non-logged-in users
                document.querySelectorAll('.comment-form, .reply-form').forEach(form => {
                    form.style.display = 'none';
                });
            }
        }

        // Run when page loads
        document.addEventListener('DOMContentLoaded', () => {
            // Add a class to indicate the page is ready
    document.body.classList.add('page-loaded');

        updateUI();
            
            // Handle post creation form submission
            const createPostForm = document.getElementById('createPostForm');
            if (createPostForm) {
                createPostForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    //Check login status before submitting
                    const loginstatus=await checkLoginStatus();
                    if(!loginstatus){
                        alert('PLease log in to create a post')
                        window.location.href='/login'
                        return;
                    }
                    const formData = new FormData(e.target);
                    const response = await fetch('/post', {
                        method: 'POST',
                        body: formData,
                        redirect: 'follow'
                    });

                    if (response.redirected) {
                        window.location.href = response.url;
                    } else if (response.ok) {
                        alert('Post created successfully!');
                        window.location.href = '/allposts';
                    // } else if (response.status === 401) {
                    //     alert('Failed to create post: user not logged in.');
                    //     window.location.href = '/login';
                    } else {
                        alert('Failed to create post.');
                    }
                });
            }

        //     //Add a 'Create Post' button for non-logged in users
        //     async function updateUI(){
        //         const isLoggedIn= await checkLoginStatus();
        //         const navContainer=document.getElementById('nav-container');
        //         const createPostSEction=document.getElementById('create-post-section');

        //         //Clear existing nav buttons
        //         navContainer.innerHTML='';

        //         if (isLoggedIn) {
        // // Show logout button and profile link
        // navContainer.innerHTML = `
        //     <a href="/profile" class="nav-btn">Profile</a>
        //     <button class="nav-btn logout-btn" id="logoutBtn">Logout</button>
        // `;
        // // Show create post form
        // if (createPostSection) {
        //     createPostSection.style.display = 'block';
        // }
        
        // // Show all forms that need authentication
        // document.querySelectorAll('.comment-form, .reply-form').forEach(form => {
        //     form.style.display = 'block';
        // });
        
        // // Add logout functionality
        // document.getElementById('logoutBtn').addEventListener('click', async () => {
        //     const response = await fetch('/logout', {
        //         method: 'POST',
        //         credentials: 'include'
        //     });
            
        //     if (response.ok) {
        //         window.location.href = '/';
        //     }
        // });
        //         }else{
        //             //Show login and register buttons
        //             navContainer.innerHTML=`
        //                <a href="/login" class="nav-btn">Login</a>
        //     <a href="/register" class="nav-btn">Register</a>
        //             `;
        //             //Hide create post form but add a login prompt button
        //             if(createPostSection){
        //                 createPostSection.style.display='none';

        //                 //Add a "Create Post " button that redirects to login
        //                 const createPostPrompt=document.createElement('div');
        //                 createPostPrompt.className = 'forms-section';
        //     createPostPrompt.innerHTML = `
        //         <h2>Create New Post</h2>
        //         <p>Please <a href="/login">log in</a> to create a post</p>
        //         <button id="login-to-post" class="nav-btn">Login to Post</button>
        //     `;
        //     createPostSection.parentNode.insertBefore(createPostPrompt, createPostSection);
        //     // Add event listener to the login button
        //     document.getElementById('login-to-post').addEventListener('click', () => {
        //         window.location.href = '/login';
        //     });

        //             }
        //         }
        //     }

            // Handle filter posts form submission
            const filterPostsForm = document.getElementById('filterposts');
            if (filterPostsForm) {
                filterPostsForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const formData = new FormData(e.target);
                    const response = await fetch('/filtered_posts', {
                        method: 'POST',
                        body: formData,
                        redirect: 'follow'
                    });

                    if (response.redirected) {
                        window.location.href = response.url;
                    } else if (response.ok) {
                        window.location.reload();
                    } else {
                        alert('Failed to filter posts.');
                    }
                });
            }

        // Handle like/dislike form submissions
document.querySelectorAll('.like-form').forEach(form => {
    form.addEventListener('submit', async (event) => {
        event.preventDefault();

          // Check login status first
          const isLoggedIn = await checkLoginStatus();
        if (!isLoggedIn) {
            alert('Please log in to like or dislike content');
            window.location.href = '/login';
            return;
        }

        const formData = new URLSearchParams();
        const id = event.target.querySelector('input[name="id"]').value;
        const itemType = event.target.querySelector('input[name="item_type"]').value;
        const actionType = event.submitter.value; // 'like' or 'dislike'
        
   
        formData.append('id', id);
        formData.append('item_type', itemType);
        formData.append('type', actionType);

        try {
            const response = await fetch('/likes', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: formData
            });

            if (response.ok) {
                const data = await response.json();
                
                // Update both like and dislike counts based on returned data
                const likeCountSpan = document.getElementById(`like-count-${itemType}-${id}`);
                const dislikeCountSpan = document.getElementById(`dislike-count-${itemType}-${id}`);
                
                if (likeCountSpan && data.likeCount !== undefined) {
                    likeCountSpan.textContent = data.likeCount;
                }
                
                if (dislikeCountSpan && data.dislikeCount !== undefined) {
                    dislikeCountSpan.textContent = data.dislikeCount;
                }
                
                // Toggle active state on buttons
                const likeButton = event.target.querySelector('button[value="like"]');
                const dislikeButton = event.target.querySelector('button[value="dislike"]');
                
                if (actionType === 'like') {
                    likeButton.classList.toggle('active', data.liked);
                    dislikeButton.classList.remove('active');
                } else {
                    dislikeButton.classList.toggle('active', data.disliked);
                    likeButton.classList.remove('active');
                }
            } else if (response.status === 401) {
                alert('Please log in to like or dislike content');
                window.location.href = '/login';
            } else {
                const errorText = await response.text();
                console.error('Error:', errorText);
                alert('Failed to process like/dislike');
            }
        } catch (error) {
            console.error('Request failed:', error);
            alert('Failed to process request');
        }
    });
});

// Add CSS for active state
document.head.insertAdjacentHTML('beforeend', `
<style>
    .like-form button.active {
        background-color: #2c3e50;
        color: white;
    }
</style>
`);
// Handle comment form submissions
document.querySelectorAll('.comment-form').forEach(form => {
    form.addEventListener('submit', async (event) => {
        event.preventDefault();
            // Check login status first
            const isLoggedIn = await checkLoginStatus();
        if (!isLoggedIn) {
            alert('Please log in to comment');
            window.location.href = '/login';
            return;
        }

        const formData = new URLSearchParams(new FormData(event.target));

        try {
            const response = await fetch('/add_comment', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: formData
            });

            if (response.ok) {
                // Get the new comment data
                const commentData = await response.json();
                
                // Find the post to add the comment to
                const postId = formData.get('post_id');
                const postElement = document.getElementById(`comments-${postId}`).closest('.post');
                
                // Create and add the new comment element without page reload
                if (postElement) {
                    const commentHTML = createCommentHTML(commentData);
                    const commentsSection = postElement.querySelector('h4').nextElementSibling;
                    commentsSection.insertAdjacentHTML('afterend', commentHTML);
                    
                    // Clear the comment input
                    event.target.querySelector('input[name="content"]').value = '';
                } else {
                    // Fallback to reload if DOM manipulation fails
                    window.location.reload();
                }
            } else if (response.status === 401) {
                alert('Failed to comment: user not logged in.');
                window.location.href = '/login';
            } else {
                alert('Failed to comment.');
            }
        } catch (error) {
            console.error('Request failed:', error);
            alert('An error occurred while adding your comment');
        }
    });
});

// Helper function to create comment HTML
function createCommentHTML(comment) {
    return `
    <div class="comment">
        <p>${comment.content}</p>
        <p><small>Posted just now</small></p>

        <form class="like-form" action="/likes" method="POST">
            <input type="hidden" name="id" value="${comment.id}">
            <input type="hidden" name="item_type" value="comment">
            <button type="submit" name="type" value="like">
                üëç Like (<span id="like-count-comment-${comment.id}">0</span>)
            </button>
            <button type="submit" name="type" value="dislike">
                üëé Dislike (<span id="dislike-count-comment-${comment.id}">0</span>)
            </button>
        </form>
        
        <form action="/add_reply" method="POST" class="reply-form" id="reply-${comment.id}">
            <input type="hidden" name="parent_comment_id" value="${comment.id}">
            <input type="text" name="content" placeholder="Reply to this comment...">
            <button type="submit">‚Ü©Ô∏è Reply</button>
        </form>
    </div>
    `;
}

// Handle reply form submissions
document.querySelectorAll('.reply-form').forEach(form => {
    form.addEventListener('submit', async (event) => {
        event.preventDefault();

         // Check login status first
         const isLoggedIn = await checkLoginStatus();
        if (!isLoggedIn) {
            alert('Please log in to reply');
            window.location.href = '/login';
            return;
        }

        const formData = new URLSearchParams(new FormData(event.target));

        try {
            const response = await fetch('/add_reply', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: formData
            });

            if (response.ok) {
                // Similar to comment submission, we can add the reply to the DOM
                // or just reload the page for simplicity
                const replyData = await response.json();
                
                // Clear the reply input
                event.target.querySelector('input[name="content"]').value = '';
                
                // Add notification of successful reply
                const successMessage = document.createElement('div');
                successMessage.className = 'alert-success';
                successMessage.textContent = 'Reply added successfully!';
                event.target.appendChild(successMessage);
                
                // Remove success message after 3 seconds
                setTimeout(() => {
                    successMessage.remove();
                }, 3000);
            } else if (response.status === 401) {
                alert('Failed to reply: user not logged in.');
                window.location.href = '/login';
            } else {
                alert('Failed to add reply.');
            }
        } catch (error) {
            console.error('Request failed:', error);
            alert('An error occurred while adding your reply');
        }
    });
});

// Add auth check endpoint routing
async function setupSPA() {
    // Add state handling for SPA behavior
    window.addEventListener('popstate', handleRouteChange);
    
    // Intercept all internal navigation link clicks
    document.addEventListener('click', (e) => {
        // Find closest anchor tag if clicking on a child element
        const anchor = e.target.closest('a');
        
        // Skip if not a link click or it's an external link
        if (!anchor || anchor.getAttribute('target') === '_blank' || 
            anchor.getAttribute('href').startsWith('http')) {
            return;
        }
        
        // Prevent default navigation
        e.preventDefault();
        
        // Get the URL
        const href = anchor.getAttribute('href');
        
        // Update browser history and load content
        history.pushState({}, '', href);
        handleRouteChange();
    });
    
    // Initial route handling
    handleRouteChange();
}

// Function to handle route changes for SPA behavior
async function handleRouteChange() {
    const path = window.location.pathname;
    
    // Never intercept these routes - let server handle them
    if (['/login', '/register', '/profile'].includes(path)) {
        return; // Allow full page load
    }

    try {
        const response = await fetch(path, {
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        });

        if (response.ok) {
            const data = await response.json();
            updatePostsContent(data);
        } else {
            window.location.reload();
        }
    } catch (error) {
        console.error('Route error:', error);
        window.location.reload();
    }
}

// Update the posts content without page reload
function updatePostsContent(data) {
    // This function would update the posts display with new data
    // Implementation depends on your specific data structure
    
    // Example:
    const postsContainer = document.querySelector('.container');
    
    // Update posts if data contains posts
    if (data.posts) {
        // Clear existing posts
        const postsSection = document.createElement('div');
        postsSection.innerHTML = '<h1>Posts</h1>';
        
        // Add each post to the container
        data.posts.forEach(post => {
            const postElement = document.createElement('div');
            postElement.className = 'post';
            // Build post HTML from data...
            // This would mirror your template rendering logic
            
            postsSection.appendChild(postElement);
        });
        
        // Replace old posts with new ones
        const oldPostsSection = postsContainer.querySelector('h1').parentElement;
        oldPostsSection.replaceWith(postsSection);
    }
}

        

// Initialize SPA behavior
setupSPA();
        });
    </script>
<!-- </body>
</html> -->