<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Forum</title>
    <link rel="stylesheet" href="/styling/style.css">
    <link rel="stylesheet" href="https://unicons.iconscout.com/release/v2.1.6/css/unicons.css">
</head>



<body>

    <!--========================== NAV BAR ==========================-->
    <nav>

        <div class="container">
            <i class="uil uil-bars"></i>

            <h2 class="logo">
                Forum
            </h2>

            <div class="search-bar">
                <i class="uil uil-search"></i>
                <input type="search" placeholder="Not functional yet">
            </div>

            <div class="create">
                {{if .UserName}}
                <a href="/logout" class="btn btn-primary">Logout</a>
                {{else}}
                <a href="/login" class="btn btn-primary">Login</a>
                <a href="/register" class="btn btn-primary">Register</a>
                {{end}}
            </div>
            <i class="uil uil-clipboard-alt mobRight"></i>
        </div>

    </nav>
    <!--========================== END OF NAV BAR ==========================-->

    <!----------------------- MAIN ----------------------->
    <main>
        <div class="container">

            <!--====================== LEFT ======================-->
            <div class="left">

                <!------------ PROFILE ------------>
                {{ if .UserName }}
                <div class="profile-card">
                    <!-- Profile Photo Section -->
                    <div class="profile-info">
                        <div class="profile-photo">
                            {{ if .ProfilePicture }}
                            <img src="data:{{ .ContentType }};base64,{{ .ProfilePicture }}" alt="Profile Picture">
                            {{ else }}
                            <div class="initials">{{ .Initial }}</div>
                            <p class="text-muted">Upload your profile picture</p>
                            {{ end }}
                        </div>

                        <!-- User Info Section -->
                        <div class="handle">
                            <h4>{{ .UserName }}</h4>
                        </div>
                    </div>
                    <!-- Profile Picture Upload Form -->
                    <form action="/upload-profile" method="POST" enctype="multipart/form-data" class="upload-form"
                        id="profile-upload-form">

                        <label for="profile-upload" class="upload-label">
                            <i class="uil uil-camera"></i> Change Photo
                        </label>
                        <input type="file" id="profile-upload" name="profile_picture" accept="image/*">
                        <button type="submit">Upload</button>
                    </form>
                </div>
                {{ else }}
                <div class="profile-card">
                    <div class="profile-photo">
                        <div class="initials">G</div>
                    </div>
                    <div class="handle">
                        <h4>Guest Mode</h4>
                        <p class="text-muted">Please login or create an account</p>
                    </div>
                </div>
                {{ end }}


                <!------------ END OF PROFILE ------------>

                {{ if .UserName}}
                <!------------- SIDEBAR ------------->
                <div class="sidebar">
                    <!-- <a class="menu-item active"> -->
                    <a href="/allposts" class="menu-item {{if eq .ViewType " all"}}active{{end}}">
                        <span>
                            <i class="uil uil-home"></i>
                        </span>
                        <h3 class="res">Home</h3>
                    </a>

                    <a href="/my_posts" class="menu-item {{if eq .ViewType " mine"}}active{{end}}">
                        <span><i class="uil uil-pen"></i></span>
                        <h3 class="res">My Posts</h3>
                    </a>

                    <a href="/liked_posts" class="menu-item {{if eq .ViewType " liked"}}active{{end}}">
                        <span><i class="uil uil-thumbs-up"></i></span>
                        <h3 class="res">Liked Posts</h3>
                    </a>
                </div>
                <!-------------END OF  SIDEBAR ------------->

                <div class="sidebar">
                    <div class="create-post">
                        <div class="heading">
                            <i class="uil uil-plus-circle"></i>
                            <h2 class="res">create Post</h2>
                        </div>

                        <!------------------- CREATE POST ------------------->
                        <form action="/post" method="POST" id="createPostForm" enctype="multipart/form-data"
                            class="create-post">


                            <input type="text" name="post_title" placeholder="Enter title of your post"
                                id="create-post">
                            <h4>Content</h4>
                            <div>
                                <textarea name="post_content" placeholder="what's on your mind"
                                    id="create-post"></textarea>
                            </div>

                            <label for="media"><i class="uil uil-image-plus"></i> </label>
                            <input type="file" id="media" name="media" accept=".jpg,.jpeg,.png,.gif,.mp4,.mov,.webm"
                                hidden>
                            <span id="file-name">Choose Image to Post.</span>


                            <h3>Choose the Categories:</h3>
                            <div class="category-group">
                                {{range .Categories}}
                                <div class="category-option">
                                    <input type="checkbox" id="cat-{{.ID}}" name="categories" value="{{.Name}}">
                                    <label for="cat-{{.ID}}">
                                        <p>{{.Name}}</p>
                                    </label>
                                </div>
                                {{end}}
                            </div>
                            <input type="submit" value="Post" class="btn btn-primary">
                        </form>
                        <!------------------- END OF CREATE POST ------------------->
                    </div>

                </div>
                {{end}}
            </div>

            <!--====================== END OF LEFT ======================-->



            <!--====================== MIDDLE ======================-->
            <div class="middle">



                <!---------------------- FEEDS/POSTS ---------------------->
                <div class="feeds">
                    {{range .Posts}}
                    <!---------------------- FEED 1 ---------------------->
                    <div class="feed" id="{{.PostId}}">

                        <!--======= user  =======-->
                        <div class="head">
                            <div class="user">
                                <div class="profile-photo">
                                    <!-- <img src="images/profile-10.jpg"> -->
                                    <p>{{.Initial}}</p>
                                </div>

                                <div class="info">
                                    <h3>{{.UserName}}</h3>
                                    <small> {{.CreatedAt}}</small>
                                </div>
                            </div>
                            <span class="edit">
                                <i class="uil uil-ellipsis-h"></i>
                            </span>
                        </div>
                        <!--======= END OF user  =======-->


                        <!--======= POST CONTENT  =======-->
                        <div class="feed-content">
                            <h3>{{.Title}}</h3>
                            <pre>{{.Content}}</pre>
                        </div>
                        <!--======= END OF POST CONTENT  =======-->

                        {{if .MediaString}}
                        <!--======= POST IMAGE  =======-->
                        <div class="photo">
                            {{if or (eq .ContentType "image/jpeg") (eq .ContentType "image/png") (eq .ContentType
                            "image/gif")}}
                            <img src="data:{{.ContentType}};base64,{{.MediaString}}" alt="Post image"
                                class="post-media">
                            {{end}}
                        </div>
                        <!--======= END OF POST IMAGE  =======-->
                        {{end}}

                        <div class="action-button">

                            <!------------ LIKES AND DISLIKES ------------>
                            <form class="like-form" action="/likes" method="POST">
                                <div class="interaction-buttons">
                                    <input type="hidden" name="id" value="{{.PostId}}">
                                    <input type="hidden" name="item_type" value="post">
                                    <button type="submit" name="type" value="like" class="reactions">
                                        <i class="uil uil-thumbs-up"></i>
                                        <h6 id="" class="like">{{.Likes}}</h6>
                                    </button>

                                    <button type="submit" name="type" value="dislike" class="reactions">
                                        <i class="uil uil-thumbs-down"></i>
                                        <h6 class="dislike">{{.Dislikes}}</h6>
                                    </button>
                                </div>
                            </form>


                            <!--======= comment button =======-->
                            <div class="comment">
                                <span><i class="uil uil-comment-alt-dots" id="{{.PostId}}"></i></span>
                                <span>{{.CommentsLenght}}</span>
                            </div>
                            <!--======= END OF comment button =======-->
                        </div>

                        <!------------ END OF LIKES AND DISLIKES ------------>



                        <div class="comments" style="display: none;" id="post-{{.PostId}}">
                            <p>Post ID {{.PostId}}</p>
                            <!----------------- Comment Form ----------------->
                            <form action="/add_comment" method="POST" class="comment-form" id="comments-{{.ID}}">
                                <input type="hidden" name="post_id" value="{{.PostId}}">
                                <input type="text" name="content" placeholder="Add a comment...">
                                <input type="submit" value="Comment" class="btn btn-primary">
                            </form>
                            <!----------------- END OF Comment Form ----------------->

                            {{range .Comments}}
                            <div class="comment_card">

                                <!--============== user Profile ==============-->
                                <div class="head">
                                    <div class="user">
                                        <div class="profile-photo">
                                            <!-- <img src="images/profile-10.jpg"> -->
                                            <p>{{.Initial}}</p>
                                        </div>

                                        <div class="info">
                                            <h3>{{.UserName}}</h3>
                                            <small>Dubai, 15minute ago</small>
                                        </div>
                                    </div>
                                </div>
                                <!--============== End Of user Profile  ==============-->



                                <!--======= comment CONTENT  =======-->
                                <div class="feed-content">
                                    <p>{{.Content}}</p>
                                </div>
                                <!--======= END OF comment CONTENT  =======-->



                                <div class="action-button">

                                    <!------------ LIKES AND DISLIKES ------------>
                                    <form class="like-form" action="/likes" method="POST">
                                        <div class="interaction-buttons">
                                            <input type="hidden" name="id" value="{{.ID}}">
                                            <input type="hidden" name="item_type" value="comment">
                                            <button type="submit" name="type" value="like" class="reactions">
                                                <i class="uil uil-thumbs-up"></i>
                                                <h6 id="" class="like">{{.Likes}}</h6>
                                            </button>

                                            <button type="submit" name="type" value="dislike" class="reactions">
                                                <i class="uil uil-thumbs-down"></i>
                                                <h6 class="dislike">{{.Dislikes}}</h6>
                                            </button>
                                        </div>
                                    </form>
                                    <span>
                                        <h6 class="uil reply-btn" id="{{.ID}}">Reply {{.RepliesLenght}}</h6>
                                    </span>

                                </div>



                                <div id="reply-{{.ID}}" style="display: none;">
                                    <p>Comment ID {{.ID}}</p>

                                    <form action="/add_reply" method="POST" class="reply-form" id="comments-{{.ID}}">
                                        <input type="hidden" name="parent_comment_id" value="{{.ID}}">
                                        <input type="text" name="content" placeholder="Add a reply...">
                                        <input type="submit" value="Reply" class="btn btn-primary">
                                    </form>


                                    {{range .Replies}}
                                    <div class="comment_card">

                                        <!--============== user Profile ==============-->
                                        <div class="head">
                                            <div class="user">
                                                <div class="profile-photo">
                                                    <!-- <img src="images/profile-10.jpg"> -->
                                                    <p>{{.Initial}}</p>
                                                </div>

                                                <div class="info">
                                                    <h3>{{.UserName}}</h3>
                                                    <small>Dubai, 15minute ago</small>
                                                </div>
                                            </div>
                                        </div>
                                        <!--============== End OF user Profile ==============-->


                                        <!--======= comment CONTENT  =======-->
                                        <div class="feed-content">
                                            <p>{{.Content}}</p>
                                        </div>
                                        <!--======= END OF comment CONTENT  =======-->


                                        <div class="action-button">

                                            <!------------ LIKES AND DISLIKES ------------>

                                            <form class="like-form" action="/likes" method="POST">
                                                <div class="interaction-buttons">
                                                    <input type="hidden" name="id" value="{{.ID}}">
                                                    <input type="hidden" name="item_type" value="comment">
                                                    <input type="hidden" name="item_type" value="post">
                                                    <button type="submit" name="type" value="like" class="reactions">
                                                        <i class="uil uil-thumbs-up"></i>
                                                        <h6 id="" class="like">{{.Likes}}</h6>
                                                    </button>

                                                    <button type="submit" name="type" value="dislike" class="reactions">
                                                        <i class="uil uil-thumbs-down"></i>
                                                        <h6 class="dislike">{{.Dislikes}}</h6>
                                                    </button>
                                                </div>
                                            </form>
                                            <span>
                                                <h6 class="uil reply-btn" id="{{.ID}}">Reply {{.RepliesLenght}}</h6>
                                            </span>
                                        </div>

                                        <!-- <form action="/add_reply" method="POST" class="reply-form" id="comments-{{.ID}}">
                                            <input type="hidden" name="parent_comment_id" value="{{.ID}}">
                                            <input type="text" name="content" placeholder="Add a comment...">
                                            <input type="submit" value="Reply" class="btn btn-primary">
                                        </form> -->

                                    </div>
                                    {{end}}

                                </div>



                            </div>
                            {{end}}
                        </div>

                    </div>
                    <!---------------------- END OF FEED 1 ---------------------->
                    {{end}}
                </div>
                <!---------------------- END OF FEEDS/POSTS ---------------------->
            </div>

            <!--====================== RIGHT ======================-->
            <div class="right">

                <div class="categories">
                    <div class="heading">
                        <h4 class="res"> Filter by categories</h4>
                    </div>

                    <!---------------------- Categories ---------------------->
                    <form action="/filtered_posts" method="POST" id="filterposts" class="res">
                        <div class="category-group">
                            {{range .Categories}}
                            <div class="category-option">
                                <input type="checkbox" id="cat-{{.ID}}" name="filteredcategories" value="{{.Name}}">
                                <label for="cat-{{.ID}}">
                                    <h5>{{.Name}}</h5>
                                </label>
                            </div>
                            {{end}}
                        </div>
                    </form>
                    <!---------------------- END OF Categories ---------------------->
                </div>


            </div>
            <!--====================== END OF RIGHT ======================-->
        </div>
    </main>
    <!----------------------- END OF MAIN ----------------------->
</body>
<script>
    //profile 
document.getElementById('profile-upload').addEventListener('submit', function(e) {
    const fileInput = document.getElementById('profile-upload');
    if (!fileInput.files.length===0) {
      e.preventDefault()
        alert('please select a file first')
    }
});

document.addEventListener("DOMContentLoaded", function() {
        document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
            checkbox.checked = false;
        });
    });


    document.querySelector(".uil-bars").addEventListener("click", function() {
        let leftElement = document.querySelector(".left"); 
        leftElement.style.display = leftElement.style.display === "block" ? "none" : "block";
    });

    document.querySelector(".uil-clipboard-alt").addEventListener("click", function() {
        let rightElement = document.querySelector(".right");
        rightElement.style.display = rightElement.style.display === "block" ? "none" : "block";
    });   
    

    document.addEventListener("DOMContentLoaded", function () {
        document.querySelectorAll(".uil-comment-alt-dots").forEach(icon => {
            icon.addEventListener("click", function () {
                let commentId = this.id; 
                let commentElement = document.getElementById("post-" + commentId);
                console.log("Comment btn clicked and ID = ", commentId)
                
                if (commentElement) {
                    commentElement.style.display = commentElement.style.display === "block" ? "none" : "block";
                }
            });
        });

        document.querySelectorAll(".reply-btn").forEach(btn => {
            btn.addEventListener("click", function () {                
                let replyId = this.id; 
                let replyElement = document.getElementById("reply-" + replyId);
                console.log("reply btn clicked and ID = ", replyId)
                
                if (replyElement) {
                    replyElement.style.display = replyElement.style.display === "block" ? "none" : "block";
                }
            });
        });

        document.querySelectorAll('input[name="filteredcategories"]').forEach(btn =>{
            btn.addEventListener("click", filterByCategories);
        });
        
    });


    // Handle post creation form submission
    document.getElementById('createPostForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const response = await fetch('/post', {
                method: 'POST',
                body: formData
            });

            if (response.ok) {
                console.log('post created')
                alert('Post created successfully!');
                window.location.href = '/allposts';
            } else if (response.status === 401) {
                alert('Failed to create post: user not logged in.');
                window.location.href = '/login';
            } else {
                alert('Failed to create post.');
                // window.location.reload();
            }
        });

        // Handle like/dislike form submissions
        // Like/dislike handler for both posts and comments
       // Like/dislike handler for both posts and comments
       document.addEventListener('DOMContentLoaded', function() {
    // Find all like/dislike forms
    const likeForms = document.querySelectorAll('form.like-form');
    
    likeForms.forEach(form => {
        form.addEventListener('submit', function(e) {
            // Prevent the default form submission
            e.preventDefault();
            
            // Create a new FormData object from the form
            const formData = new FormData(this);
            
            // Add the clicked button's value explicitly
            // In modern browsers, we can use e.submitter to get the clicked button
            if (e.submitter) {
                formData.set('type', e.submitter.value);
            } else {
                // Fallback for older browsers - try to determine which button was clicked
                const clickedButton = document.activeElement;
                if (clickedButton && clickedButton.getAttribute('value')) {
                    formData.set('type', clickedButton.getAttribute('value'));
                }
            }
            
            // Log the form data to confirm
            console.log('Form data being sent:');
            for (let pair of formData.entries()) {
                console.log(pair[0] + ': ' + pair[1]);
            }
            
            const itemId = formData.get('id');
            const itemType = formData.get('item_type');
            const actionType = formData.get('type'); // 'like' or 'dislike'
            
            // Reference to the buttons that contain the counts
            const likeButton = this.querySelector('button[value="like"]');
            const dislikeButton = this.querySelector('button[value="dislike"]');
            const likeCountElement = likeButton.querySelector('.like');
            const dislikeCountElement = dislikeButton.querySelector('.dislike');
            
            // Send AJAX request
            fetch('/likes', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                // First check if the response is JSON
                const contentType = response.headers.get('content-type');
                if (contentType && contentType.includes('application/json')) {
                    // It's JSON, so parse it
                    return response.json().then(data => {
                        return { status: response.status, data, isJson: true };
                    });
                } else {
                    // Not JSON, get text instead
                    return response.text().then(text => {
                        return { status: response.status, text, isJson: false };
                    });
                }
            })
            .then(result => {
                console.log('Response:', result);
                
                if (result.status === 200 && result.isJson) {
                    // Success with JSON data
                    const data = result.data;
                    // Update the UI with new counts
                    if (data.likes !== undefined) {
                        likeCountElement.textContent = data.likes;
                    }
                    if (data.dislikes !== undefined) {
                        dislikeCountElement.textContent = data.dislikes;
                    }
                    
                    const clickedButton = actionType === 'like' ? likeButton : dislikeButton;
                    clickedButton.classList.add('active-reaction');
                    setTimeout(() => {
                        clickedButton.classList.remove('active-reaction');
                    }, 500);
                } else if (result.status === 401) {
                    alert('Please log in to like/dislike posts');
                    window.location.href = '/login';
                } else {
                    // Handle other error cases
                    const errorMessage = result.isJson && result.data.error 
                        ? result.data.error 
                        : 'Failed to process like/dislike';
                    console.error('Error response:', result.isJson ? result.data : result.text);
                    alert(errorMessage);
                }
            })
            .catch(error => {
                console.error('Network or parsing error:', error);
                alert('An error occurred while processing your request');
            });
        });
    });
});
        //filter posts by categories
        async function filterByCategories() {
            const checkboxes = document.querySelectorAll('input[name="filteredcategories"]:checked');
            
            
            const selectedCategories = Array.from(checkboxes).map(checkbox => checkbox.value);

            console.log("Categories Sent:", selectedCategories, selectedCategories.length); 

            try {
                const response = await fetch("/filtered_posts", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({ categories: selectedCategories }),
                });

                const data = await response.json();
                console.log("Filtered Data:", data);
                if (selectedCategories.length === 0){
                    data[0] = "all"
                }
                filter(data)
            } catch (error) {
                console.error("Error filtering:", error);
            }
        }

        function filter(data) {

            document.querySelectorAll(".feed").forEach(feed => {                   

                if (data[0] === "all"){
                    feed.style.display = "block"
                }else{
                    if (data.includes(feed.id )){
                        feed.style.display = "block"
                    }else{
                        feed.style.display = "none"
                    }
                }
            })
        }


        


        // Handle comment form submissions
        document.querySelectorAll('.comment-form').forEach(form => {
            form.addEventListener('submit', async (event) => {
                event.preventDefault();

                const formData = new URLSearchParams(new FormData(event.target));

                try {
                    const response = await fetch('/add_comment', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: formData
                    });

                    if (response.ok) {
                        alert('Comment created successfully');
                        window.location.reload();
                    } else if (response.status === 401) {
                        alert('Failed to comment: user not logged in.');
                        window.location.href = '/login';
                    } else {
                        alert('Failed to comment.');
                    }
                } catch (error) {
                    console.error('Request failed:', error);
                }
            });
        });

        // Handle comment form submissions
        document.querySelectorAll('.reply-form').forEach(form => {
            form.addEventListener('submit', async (event) => {
                event.preventDefault();

                const formData = new URLSearchParams(new FormData(event.target));

                try {
                    const response = await fetch('/add_reply', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: formData
                    });

                    if (response.ok) {
                        alert('Comment created successfully');
                        window.location.reload();
                    } else if (response.status === 401) {
                        alert('Failed to comment: user not logged in.');
                        window.location.href = '/login';
                    } else {
                        alert('Failed to comment.');
                    }
                } catch (error) {
                    console.error('Request failed:', error);
                }
            });
        });

        document.getElementById("media").addEventListener("change", function () {
            let fileName = this.files.length ? this.files[0].name : "No file selected";
            document.getElementById("file-name").textContent = fileName;
        });

</script>

</html>